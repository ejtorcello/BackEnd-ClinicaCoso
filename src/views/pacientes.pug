doctype html
html
  head
    title= titulo
    link(rel="stylesheet" href="/css/styles.css")

  body
    button.theme-toggle(id="themeBtn") üåô
    nav
      a.btn(href="/") ‚Üê Volver al Inicio
    
    .pacientes-content
      h1= titulo
      
      if ['admin', 'recepcionista'].includes(usuario.rol)
        button.btn(onclick="abrirModalCrear()") + Nuevo Paciente

      if pacientes.length
        table
          thead
            tr
              th ID
              th Nombre
              th Apellido
              th Telefono
              th Domicilio
              th Edad
              th Diagn√≥stico
              th Turnos
              if ['admin', 'recepcionista'].includes(usuario.rol)
                th Acciones
          tbody
            each paciente in pacientes
              tr
                td= paciente.id
                td= paciente.nombre
                td= paciente.apellido
                td= paciente.telefono
                td= paciente.domicilio
                td= paciente.edad
                td= paciente.diagnostico
                td
                  if paciente.turnos.length
                    ul.turnos-list
                      each turno in paciente.turnos
                        - const isPast = new Date(turno.fechaHora) < new Date();
                        li.turno-item(class=isPast ? 'turno-vencido' : '')
                          span.turno-text= turno.fechaHora
                          button.btn-icon-eliminar(type="button" 
                                             data-paciente-id=paciente.id 
                                             data-turno-id=turno.id 
                                             data-turno-fecha=turno.fechaHora 
                                             title="Eliminar turno") x
                  else
                    | Sin turnos
                if ['admin', 'recepcionista'].includes(usuario.rol)
                  td
                    form(action=`/pacientes/${paciente.id}?_method=DELETE` method="POST" onsubmit="return confirm('¬øEliminar paciente?');")
                       //- Simular DELETE con POST si no hay method-override configurado, o usar fetch. 
                       //- Asumiremos que el controller acepta POST o que hay method-override. 
                       //- Si no, usaremos JS. Por simplicidad, usaremos un script simple para eliminar.
                       button.btn.btn-danger(type="button" onclick=`eliminarPaciente('${paciente.id}')`) Eliminar

      else
        p No hay pacientes registrados.

    // Modal Crear Paciente
    .modal#modalCrearPaciente(style="display:none;")
      .modal-content
        h2 Nuevo Paciente
        form(action="/pacientes" method="POST")
          .form-group
            label(for="nombre") Nombre:
            input(type="text" name="nombre" required)
          .form-group
            label(for="apellido") Apellido:
            input(type="text" name="apellido" required)
          .form-group
            label(for="telefono") Telefono:
            input(type="text" name="telefono")
          .form-group
            label(for="domicilio") Domicilio:
            input(type="text" name="domicilio")
          .form-group
            label(for="F_Nac") Fecha de Nacimiento:
            input(type="date" name="F_Nac" required)
          .form-group
            label(for="diagnostico") Diagn√≥stico Inicial:
            input(type="text" name="diagnostico" required)
          .modal-buttons
            button.btn-cancelar(type="button" onclick="cerrarModalCrear()") Cancelar
            button.btn(type="submit") Guardar

    script.
      function abrirModalCrear() {
        const today = new Date().toISOString().split('T')[0];
        document.querySelector('input[name="F_Nac"]').setAttribute('max', today);
        document.getElementById('modalCrearPaciente').style.display = 'flex';
      }
      function cerrarModalCrear() {
        document.getElementById('modalCrearPaciente').style.display = 'none';
      }
      function cerrarModalError() {
        document.getElementById('modalErrorEliminar').style.display = 'none';
      }

      function eliminarPaciente(id) {
        if(confirm('¬øEliminar paciente y sus turnos?')) {
          fetch('/pacientes/' + id, { method: 'DELETE' })
            .then(async res => {
              if(res.ok) {
                window.location.reload();
              } else if (res.status === 400) {
                const data = await res.json();
                document.getElementById('mensajeErrorEliminar').textContent = data.error || 'No se puede eliminar.';
                document.getElementById('modalErrorEliminar').style.display = 'flex';
              } else {
                alert('Error al eliminar');
              }
            })
            .catch(err => console.error(err));
        }
      }
    
    // Modal de confirmaci√≥n para eliminar turno
    .modal#modalEliminarTurno
      .modal-content
        h3 ‚ö†Ô∏è Confirmar eliminaci√≥n
        .turno-info
          .turno-fecha#fechaTurno
          .turno-hora#horaTurno
        p ¬øEst√°s seguro de que deseas eliminar este turno?
        .modal-buttons
          button.btn.btn-cancelar#btnCancelar Cancelar
          button.btn.btn-confirmar#btnConfirmarEliminar Eliminar

    // Modal Error Eliminar
    .modal#modalErrorEliminar(style="display:none;")
      .modal-content
        h3 ‚ö†Ô∏è No se puede eliminar
        p#mensajeErrorEliminar El paciente tiene turnos pendientes.
        .modal-buttons
          button.btn(type="button" onclick="cerrarModalError()") Entendido
    
    script(src="/js/theme.js")
    script(src="/js/pacientes.js")
